{% extends 'base.html' %}

{% block body %}
    <div class="row">
        {% for post in posts %}
            {% include '_card.html' %}
        {% endfor %}
    </div>

    <script> 
        // reply fomr toggle
        $('.replybutton').click(function(){
        $(this).next('.replyform_div').toggle();
        });    

        // reply create
        let replyForms = document.querySelectorAll('.reply-Form')
        replyForms.forEach(function(replyForm){
            replyForm.addEventListener('submit', function(event){
                event.preventDefault()
                const data = new FormData(event.target)
                axios.post(event.target.action, data)
                    .then(function(response){
                    const reply = response.data
                    const replyList = document.querySelector(
                        `#reply-list-${reply.postId}-${reply.commentId}`)
                    const newReply = `<div class="in">
                                ${ reply.username } : ${ reply.content }
                                <button onclick="replyDelete('${reply.postId},${reply.commentId},${reply.id}');">Delete</button>
                            </div>`
                    replyList.insertAdjacentHTML('beforeEnd', newReply)
                    event.target.reset()
                    })
                })
            })

        
        // reply_delete
            function replyDelete(value) {
                var valuesArray = value.split(',')
                var reply_id = valuesArray[2];
                var comment_id = valuesArray[1];
                var post_id = valuesArray[0];
                $.ajax({
                    type : 'POST',
                    url : `/posts/${post_id}/comments/${comment_id}/replys/${reply_id}/delete/`,
                    dataType : 'json',
                    data : {
                        'reply_id' : reply_id,
                        'comment_id': comment_id,
                        'post_id': post_id,
                        'csrfmiddlewaretoken': '{{csrf_token}}',
                    },
                    success: function(response){
                        location.reload()
                    }
                })
            }
    </script>
    
{% endblock %}
